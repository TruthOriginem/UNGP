package ungp.scripts.campaign.ui;

import com.fs.starfarer.api.EveryFrameScript;
import com.fs.starfarer.api.Global;
import com.fs.starfarer.api.Script;
import com.fs.starfarer.api.campaign.*;
import com.fs.starfarer.api.campaign.econ.Industry;
import com.fs.starfarer.api.campaign.econ.MarketAPI;
import com.fs.starfarer.api.campaign.rules.MemoryAPI;
import com.fs.starfarer.api.combat.EngagementResultAPI;
import com.fs.starfarer.api.fleet.FleetMemberAPI;
import com.fs.starfarer.api.input.InputEventAPI;
import com.fs.starfarer.api.ui.*;
import com.fs.starfarer.api.util.Misc;
import ungp.scripts.campaign.UNGP_InGameData;
import ungp.scripts.campaign.UNGP_Settings;
import ungp.scripts.campaign.background.UNGP_Background;
import ungp.scripts.campaign.background.UNGP_BackgroundManager;
import ungp.scripts.campaign.inherit.UNGP_InheritData;
import ungp.scripts.campaign.inherit.UNGP_InheritManager;
import ungp.scripts.campaign.intel.UNGP_BackgroundIntel;
import ungp.scripts.campaign.specialist.challenges.UNGP_ChallengeInfo;
import ungp.scripts.campaign.specialist.challenges.UNGP_ChallengeManager;
import ungp.scripts.campaign.specialist.intel.UNGP_ChallengeIntel;
import ungp.scripts.campaign.specialist.intel.UNGP_SpecialistIntel;
import ungp.scripts.campaign.specialist.rules.UNGP_RulePickListener;
import ungp.scripts.campaign.specialist.rules.UNGP_RulesManager;
import ungp.scripts.campaign.specialist.rules.UNGP_RulesManager.URule;
import ungp.api.backgrounds.UNGP_BackgroundPluginAPI;
import ungp.api.saves.UNGP_DataSaverAPI;
import ungp.api.saves.UNGP_DataSaverSettingEntryAPI;
import ungp.impl.saves.UNGP_BlueprintsDataSaver;
import ungp.impl.saves.UNGP_CreditsDataSaver;
import ungp.scripts.utils.UNGP_Feedback;
import org.lwjgl.input.Keyboard;
import ungp.scripts.ui.CheckBoxGroup;
import ungp.scripts.ui.HorizontalButtonGroup;
import ungp.scripts.ui.SettingEntry;

import java.awt.*;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import static ungp.scripts.utils.Constants.root_i18n;
import static ungp.scripts.campaign.specialist.UNGP_SpecialistSettings.Difficulty;
import static ungp.scripts.campaign.specialist.UNGP_SpecialistSettings.rulesMeetCondition;

public class UNGP_InteractionDialog implements InteractionDialogPlugin {
    private enum OptionID {
        CHECK_INHERIT_SLOTS,
        CHECK_RECORD_SLOTS,
        HELP,

        CHOOSE_INHERIT_SLOT_0,
        CHOOSE_INHERIT_SLOT_1,
        CHOOSE_INHERIT_SLOT_2,
        PICK_RULES,
        INHERIT,
        INHERIT_SETTINGS,

        //        START_RECORD,
        CHOOSE_RECORD_SLOT_0,
        CHOOSE_RECORD_SLOT_1,
        CHOOSE_RECORD_SLOT_2,

        BACK_TO_MENU,
        LEAVE
    }

    private InteractionDialogAPI dialog;
    private TextPanelAPI textPanel;
    private OptionPanelAPI options;
    private VisualPanelAPI visual;
    private UNGP_InteractionPanelPlugin uiPanelPlugin;

    private UNGP_InGameData inGameData;

    private boolean onlyDefaultSlot;
    private UNGP_InheritData pickedInheritData;
    private OptionID choseInheritSlotOptionID = null;

    /**
     * While dialog is loaded, the ungp.data will be generated by the current inGameData
     */
    private UNGP_InheritData pregenInheritData;
    private boolean isSpecialistMode = false;

    private InheritSettingEntry<Difficulty> settingEntry_difficulty = new InheritSettingEntry<Difficulty>(null, Difficulty.values().length + 1) {
        @Override
        public void initParams(int optionSize) {
            entryTitle = root_i18n.get("hardmodeLevel");
            entryTitleColor = Misc.getNegativeHighlightColor();
            for (int i = 0; i < optionSize; i++) {
                Difficulty difficulty;
                if (i == 0) {
                    difficulty = null;
                    optionNames[i] = "/";
                    optionBaseColor[i] = Misc.getBasePlayerColor();
                    optionDarkColor[i] = Misc.getDarkPlayerColor();
                    optionBrightColor[i] = Misc.getBrightPlayerColor();
                } else {
                    difficulty = Difficulty.values()[i - 1];
                    optionNames[i] = difficulty.name;
                    optionBaseColor[i] = difficulty.color;
                    optionDarkColor[i] = difficulty.color.darker();
                    optionBrightColor[i] = difficulty.color.brighter();
                }
                optionValues[i] = difficulty;
            }
        }

        @Override
        protected void addTipToOption(TooltipMakerAPI tooltip, Object option) {
            Difficulty difficulty = (Difficulty) option;
            tooltip.addTooltipToPrevious(new DifficultyTooltipCreator(difficulty), TooltipMakerAPI.TooltipLocation.BELOW);
        }
    };

    private List<URule> pickedRules = new ArrayList<>();
    private UNGP_Background pickedBackground;
    private CheckBoxGroup backgroundCheckBoxGroup;


    public UNGP_InteractionDialog(UNGP_InGameData inGameData) {
        this.inGameData = inGameData;
    }

    @Override
    public void init(InteractionDialogAPI dialog) {
        this.dialog = dialog;
        dialog.setPromptText("");
        dialog.setBackgroundDimAmount(0.4f);
        textPanel = dialog.getTextPanel();
        options = dialog.getOptionPanel();
        visual = dialog.getVisualPanel();

        pregenInheritData = UNGP_InheritData.createInheritData(inGameData);
        onlyDefaultSlot = UNGP_InheritManager.loadAllSlots();

        // The right view of the interaction dialog
        uiPanelPlugin = new UNGP_InteractionPanelPlugin();
        uiPanelPlugin.update(visual);
        initMenu();
        dialog.setOptionOnEscape(null, OptionID.LEAVE);
    }

    /**
     * The beginning of the page.
     */
    private void initMenu() {
        textPanel.addPara(root_i18n.get("menu"));
        options.addOption(root_i18n.get("checkInherit"), OptionID.CHECK_INHERIT_SLOTS);
        options.addOption(root_i18n.get("checkRecord"), OptionID.CHECK_RECORD_SLOTS);
        if (!inGameData.isInherited() && inGameData.isPassedInheritTime()) {
            textPanel.addPara(root_i18n.get("hasPassedTime"), Misc.getNegativeHighlightColor());
        }
        if (!inGameData.couldStartRecord()) {
            options.setEnabled(OptionID.CHECK_RECORD_SLOTS, false);
            if (inGameData.isRecorded()) {
                textPanel.addPara(root_i18n.get("hasRecorded"), Misc.getNegativeHighlightColor());
            }
            if (!UNGP_Settings.reachMaxLevel()) {
                textPanel.addPara(root_i18n.get("notMaxLevel"), Misc.getNegativeHighlightColor());
            }
        }
        TooltipMakerAPI toRecordInfo = textPanel.beginTooltip();
        Difficulty difficulty = null;
        if (inGameData.isHardMode()) {
            difficulty = inGameData.getDifficulty();
        }
        pregenInheritData.addRecordTooltip(toRecordInfo, difficulty);
        textPanel.addTooltip();
        options.addOption(root_i18n.get("help"), OptionID.HELP);
        addLeaveButton();
    }

    /**
     * 选择继承槽位
     */
    private void optionSelectedChooseInherit(OptionID option) {
        pickedInheritData = UNGP_InheritManager.getDataFromSlot(getSlotIdByOption(option));
        Color nC = Misc.getNegativeHighlightColor();
        if (pickedInheritData != null) {
            choseInheritSlotOptionID = option;
            TooltipMakerAPI inheritDataInfo = textPanel.beginTooltip();
            pickedInheritData.addInheritTooltip(inheritDataInfo);
            textPanel.addTooltip();

            //如果没有继承过或者没有超过时限
            if (!inGameData.isPassedInheritTime() && !inGameData.isInherited()) {
                // 继承选项
                String settingOptionStr = root_i18n.get("startSetting");
                options.addOption(settingOptionStr, OptionID.INHERIT_SETTINGS);
                options.setShortcut(OptionID.INHERIT_SETTINGS, Keyboard.KEY_S, false, false, false, true);

                if (isSpecialistMode) {
                    options.addOption(root_i18n.get("rulepick_button") + (UNGP_ChallengeManager.isDifficultyEnough(settingEntry_difficulty.getValue()) ?
                                                                          root_i18n.get("rulepick_couldChallenge") : ""), OptionID.PICK_RULES);
                    options.setShortcut(OptionID.PICK_RULES, Keyboard.KEY_R, false, false, false, true);
                    pickedRules.clear();
                }

                options.addOption(root_i18n.get("startInherit"), OptionID.INHERIT);
                options.setShortcut(OptionID.INHERIT, Keyboard.KEY_SPACE, false, false, false, true);
                updateOptionsFromSettings();
            } else {
                if (inGameData.isInherited()) {
                    textPanel.addPara(root_i18n.get("hasInherited"), nC);
                } else {
                    textPanel.addPara(root_i18n.get("hasPassedTime"), nC);
                }
            }
        } else {
            textPanel.addPara(root_i18n.get("noInherit"), nC);
        }
    }

    private void saveRecordByChosenOption(UNGP_InheritData dataToRecord, OptionID option) {
        UNGP_InheritManager.saveDataToSlot(dataToRecord, getSlotIdByOption(option));
    }

    public int getSlotIdByOption(OptionID option) {
        int slotID = 0;
        switch (option) {
            case CHOOSE_RECORD_SLOT_0:
            case CHOOSE_INHERIT_SLOT_0:
                break;
            case CHOOSE_RECORD_SLOT_1:
            case CHOOSE_INHERIT_SLOT_1:
                slotID = 1;
                break;
            case CHOOSE_RECORD_SLOT_2:
            case CHOOSE_INHERIT_SLOT_2:
                slotID = 2;
                break;
        }
        return slotID;
    }

    @Override
    public void optionSelected(String optionText, Object optionData) {
        final OptionID selectedOption = (OptionID) optionData;
        if (selectedOption != OptionID.PICK_RULES) {
            options.clearOptions();
            textPanel.clear();
            uiPanelPlugin.update(visual);
        }
        switch (selectedOption) {
            case CHECK_INHERIT_SLOTS: {
                resetSettings();
                if (!onlyDefaultSlot) {
                    textPanel.addPara(root_i18n.get("checkInherit"));
                    textPanel.addPara(root_i18n.get("checkInheritSlot"));
                    UNGP_InheritData curSlot = UNGP_InheritManager.InheritData_slot0;
                    if (curSlot == null) {
                        options.addOption(root_i18n.get("emptySlot"), OptionID.CHOOSE_INHERIT_SLOT_0);
                        options.setEnabled(OptionID.CHOOSE_INHERIT_SLOT_0, false);
                    } else {
                        int curCycle = Math.max(0, curSlot.cycle);
                        options.addOption(curSlot.getPrefixByCycle() + root_i18n.format("slotDes", curCycle + "", curSlot.lastPlayerName)
                                , OptionID.CHOOSE_INHERIT_SLOT_0, curSlot.getColorByCycle(), null);
                    }
                    curSlot = UNGP_InheritManager.InheritData_slot1;
                    if (curSlot == null) {
                        options.addOption(root_i18n.get("emptySlot"), OptionID.CHOOSE_INHERIT_SLOT_1);
                        options.setEnabled(OptionID.CHOOSE_INHERIT_SLOT_1, false);
                    } else {
                        int curCycle = Math.max(0, curSlot.cycle);
                        options.addOption(curSlot.getPrefixByCycle() + root_i18n.format("slotDes", curCycle + "", curSlot.lastPlayerName)
                                , OptionID.CHOOSE_INHERIT_SLOT_1, curSlot.getColorByCycle(), null);
                    }
                    curSlot = UNGP_InheritManager.InheritData_slot2;
                    if (curSlot == null) {
                        options.addOption(root_i18n.get("emptySlot"), OptionID.CHOOSE_INHERIT_SLOT_2);
                        options.setEnabled(OptionID.CHOOSE_INHERIT_SLOT_2, false);
                    } else {
                        int curCycle = Math.max(0, curSlot.cycle);
                        options.addOption(curSlot.getPrefixByCycle() + root_i18n.format("slotDes", curCycle + "", curSlot.lastPlayerName)
                                , OptionID.CHOOSE_INHERIT_SLOT_2, curSlot.getColorByCycle(), null);
                    }
                } else {
                    optionSelectedChooseInherit(OptionID.CHOOSE_INHERIT_SLOT_0);
                }
                addBackButton(OptionID.BACK_TO_MENU);
            }
            break;
            case CHOOSE_INHERIT_SLOT_0:
            case CHOOSE_INHERIT_SLOT_1:
            case CHOOSE_INHERIT_SLOT_2:
                optionSelectedChooseInherit(selectedOption);
                addBackButton(OptionID.CHECK_INHERIT_SLOTS);
                break;
            case CHECK_RECORD_SLOTS: {
                TooltipMakerAPI recordInfo = textPanel.beginTooltip();
                textPanel.addPara(root_i18n.get("recordInfo"));
                pregenInheritData.addRecordTooltip(recordInfo, inGameData.getDifficulty());
                textPanel.addTooltip();
                textPanel.addPara(root_i18n.get("checkRecordSlot"));
                // 三个重生槽位
                UNGP_InheritData curSlot = UNGP_InheritManager.InheritData_slot0;
                if (curSlot == null) {
                    options.addOption(root_i18n.get("emptySlot"), OptionID.CHOOSE_RECORD_SLOT_0);
                } else {
                    int curCycle = Math.max(0, curSlot.cycle);
                    options.addOption(curSlot.getPrefixByCycle() + root_i18n.format("slotDes", curCycle + "", curSlot.lastPlayerName)
                            , OptionID.CHOOSE_RECORD_SLOT_0, curSlot.getColorByCycle(), null);
                }
                curSlot = UNGP_InheritManager.InheritData_slot1;
                if (curSlot == null) {
                    options.addOption(root_i18n.get("emptySlot"), OptionID.CHOOSE_RECORD_SLOT_1);
                } else {
                    int curCycle = Math.max(0, curSlot.cycle);
                    options.addOption(curSlot.getPrefixByCycle() + root_i18n.format("slotDes", curCycle + "", curSlot.lastPlayerName)
                            , OptionID.CHOOSE_RECORD_SLOT_1, curSlot.getColorByCycle(), null);
                }
                curSlot = UNGP_InheritManager.InheritData_slot2;
                if (curSlot == null) {
                    options.addOption(root_i18n.get("emptySlot"), OptionID.CHOOSE_RECORD_SLOT_2);
                } else {
                    int curCycle = Math.max(0, curSlot.cycle);
                    options.addOption(curSlot.getPrefixByCycle() + root_i18n.format("slotDes", curCycle + "", curSlot.lastPlayerName)
                            , OptionID.CHOOSE_RECORD_SLOT_2, curSlot.getColorByCycle(), null);
                }
                addBackButton(OptionID.BACK_TO_MENU);
            }
            break;
            case HELP:
                textPanel.addPara(root_i18n.get("helpInfo"));
                addBackButton(OptionID.BACK_TO_MENU);
                break;
            case PICK_RULES:
                final List<URule> oldList = new ArrayList<>(pickedRules);
                pickedRules.clear();
                final Difficulty difficulty = settingEntry_difficulty.getValue();
                UNGP_RulesManager.setStaticDifficulty(difficulty);
                UNGP_RulePickListener pickListener = new UNGP_RulePickListener(pickedRules,
                                                                               pickedInheritData.completedChallenges,
                                                                               difficulty, new Script() {
                    @Override
                    public void run() {
                        setSpecialistModeToolTip();
                        uiPanelPlugin.update(visual);
                        TooltipMakerAPI tooltip = uiPanelPlugin.beginTooltip(0f, false);
                        tooltip.addPara(root_i18n.get("hardmodeDes"), Misc.getHighlightColor(), 0f);
                        uiPanelPlugin.addTooltip(20f, tooltip);
                        tooltip = uiPanelPlugin.beginTooltip(300f, true);
                        for (URule rule : pickedRules) {
                            TooltipMakerAPI imageMaker = tooltip.beginImageWithText(rule.getSpritePath(), 32f);
                            imageMaker.addPara(rule.getName(), rule.getCorrectColor(), 0f);
                            rule.addDesc(imageMaker, 0f);
                            tooltip.addImageWithText(3f);
                        }
                        uiPanelPlugin.addTooltip(300f, tooltip);
                        tooltip = uiPanelPlugin.beginTooltip(10f, false);
                        // 如果满足规则
                        if (!rulesMeetCondition(pickedRules, difficulty)) {
                            tooltip.setParaOrbitronLarge();
                            tooltip.addPara(root_i18n.get("rulepick_notMeet"), Misc.getNegativeHighlightColor(), 5f);
                            tooltip.setParaFontDefault();
                            uiPanelPlugin.addTooltip(10f, tooltip);

                        } else {
                            List<UNGP_ChallengeInfo> runnableChallenges = UNGP_ChallengeManager.getRunnableChallenges(difficulty, pickedRules, pickedInheritData.completedChallenges);
                            if (!runnableChallenges.isEmpty()) {
                                tooltip.addPara(root_i18n.get("rulepick_runnableChallenges"), Misc.getHighlightColor(), 10f);
                                uiPanelPlugin.addTooltip(20f, tooltip);
                                tooltip = uiPanelPlugin.beginTooltip(300f, true);
                                for (UNGP_ChallengeInfo challenge : runnableChallenges) {
                                    challenge.createTooltip(tooltip, 5f, 0);
                                }
                                uiPanelPlugin.addTooltip(300f, tooltip);
                            }
                        }
                        //                        textPanel.addTooltip();
                    }
                }, new Script() {
                    @Override
                    public void run() {
                        pickedRules.addAll(oldList);
                    }
                });
                pickListener.showCargoPickerDialog(dialog);
                break;
            case INHERIT:
                inherit();
                addLeaveButton();
                break;
            case CHOOSE_RECORD_SLOT_0:
            case CHOOSE_RECORD_SLOT_1:
            case CHOOSE_RECORD_SLOT_2:
                dialog.showCustomDialog(720f, 200f, new RecordDialogDelegate(selectedOption));
                addLeaveButton();
                break;
            case BACK_TO_MENU:
                initMenu();
                break;
            case LEAVE:
                UNGP_InheritManager.clearSlots();
                dialog.dismiss();
                break;
            case INHERIT_SETTINGS:
                float width = Global.getSettings().getScreenWidth();
                float height = Global.getSettings().getScreenHeight();
                width = width < 800 ? width : 800;
                height = height < 600 ? height : 600;
                dialog.showCustomDialog(width, height, new InheritOptionsDelegate());
                break;
            default:
                break;
        }

    }

    /**
     * 继承重生点
     */
    private void inherit() {
        TooltipMakerAPI backgroundTip = textPanel.beginTooltip();
        pickedBackground.addShortDescTooltipWithIcon(backgroundTip, 0f);
        textPanel.addTooltip();
        UNGP_BackgroundPluginAPI plugin = pickedBackground.getPlugin();

        float inherit_creditsFactor = plugin.getInheritCreditsFactor();
        float inherit_bpsFactor = plugin.getInheritBlueprintsFactor();

        Map<String, Object> dataSaverParams = new HashMap<>();
        dataSaverParams.put("inheritCreditsFactor", inherit_creditsFactor);
        dataSaverParams.put("inheritBPFactor", inherit_bpsFactor);
        dataSaverParams.put("background", pickedBackground);

        for (UNGP_DataSaverAPI dataSaver : pickedInheritData.dataSavers) {
            TooltipMakerAPI tooltip = textPanel.beginTooltip();
            dataSaver.startInheritDataFromSaver(tooltip, dataSaverParams);
            textPanel.addTooltip();
        }

        TooltipMakerAPI tooltip = textPanel.beginTooltip();
        UNGP_BackgroundManager.setPlayerBackground(pickedBackground);
        plugin.afterConfirm(pickedInheritData);
        plugin.addAfterConfirmTooltip(tooltip, pickedInheritData);
        UNGP_BackgroundIntel backgroundIntel = new UNGP_BackgroundIntel(Global.getSector().getPlayerFleet().getStarSystem());
        Global.getSector().getIntelManager().addIntel(backgroundIntel);
        textPanel.addTooltip();


        textPanel.setFontInsignia();
        if (isSpecialistMode)
            textPanel.addPara(root_i18n.get("hardModeYes"), Misc.getNegativeHighlightColor());

        inGameData.setCurCycle(pickedInheritData.cycle);
        inGameData.setInherited(true);
        inGameData.setHardMode(isSpecialistMode);
        inGameData.setCompletedChallenges(pickedInheritData.completedChallenges);
        if (isSpecialistMode) {
            inGameData.setDifficulty(settingEntry_difficulty.getValue());
            inGameData.saveActivatedRules(pickedRules);
            UNGP_Feedback.setFeedBackList(pickedRules);
            final UNGP_SpecialistIntel intel = new UNGP_SpecialistIntel();
            Global.getSector().getIntelManager().addIntel(intel, false, textPanel);
            UNGP_ChallengeIntel challengeIntel = UNGP_ChallengeManager.confirmChallenges(inGameData);
            if (challengeIntel != null) {
                Global.getSector().getIntelManager().addIntelToTextPanel(challengeIntel, textPanel);
            }
            UNGP_RulesManager.updateRulesCache();
            // Open the specialist intel
            Global.getSector().addTransientScript(new EveryFrameScript() {
                private float elapsed = 0f;
                private boolean isDone = false;

                @Override
                public boolean isDone() {
                    return isDone;
                }

                @Override
                public boolean runWhilePaused() {
                    return false;
                }

                @Override
                public void advance(float amount) {
                    if (isDone()) return;
                    elapsed += amount;
                    if (elapsed > 0.1f) {
                        isDone = true;
                        Global.getSector().getCampaignUI().showCoreUITab(CoreUITabId.INTEL, intel);
                        Global.getSector().removeTransientScript(this);
                    }
                }
            });
        }
    }

    /**
     * 记录重生点
     *
     * @param option
     */
    private void record(OptionID option) {
        inGameData.setRecorded(true);
        saveRecordByChosenOption(pregenInheritData, option);
        Global.getSoundPlayer().playUISound("ui_rep_raise", 1, 1);
        textPanel.addPara(root_i18n.get("recordSuccess"));
    }

    @Override
    public void optionMousedOver(String optionText, Object optionData) {

    }

    private void setSpecialistModeToolTip() {
        if (options.hasOption(OptionID.INHERIT)) {
            if (!pickedRules.isEmpty()) {
                String[] ruleNames = new String[pickedRules.size()];
                Color[] ruleColors = new Color[pickedRules.size()];
                StringBuilder result = new StringBuilder(root_i18n.get("hardmodeDes"));
                for (int i = 0; i < pickedRules.size(); i++) {
                    URule rule = pickedRules.get(i);
                    result.append("\n  ");
                    result.append(rule.getName());
                    ruleNames[i] = rule.getName();
                    ruleColors[i] = rule.getCorrectColor();
                }
                options.setTooltip(OptionID.INHERIT, result.toString());
                options.setTooltipHighlights(OptionID.INHERIT, ruleNames);
                options.setTooltipHighlightColors(OptionID.INHERIT, ruleColors);
            }
        }
    }

    @Override
    public void advance(float amount) {
        if (isSpecialistMode && options.hasOption(OptionID.INHERIT)) {
            options.setEnabled(OptionID.INHERIT, rulesMeetCondition(pickedRules, settingEntry_difficulty.getValue()));
        }
    }

    /**
     * 继承选项
     */
    private void updateOptionsFromSettings() {
        if (options.hasOption(OptionID.INHERIT)) {

            float inherit_creditsFactor = 0f;
            float inherit_bpsFactor = 0f;
            if (pickedBackground != null && pickedBackground.getPlugin() != null) {
                inherit_creditsFactor = pickedBackground.getPlugin().getInheritCreditsFactor();
                inherit_bpsFactor = pickedBackground.getPlugin().getInheritBlueprintsFactor();
            }

            int bpInheritGeneratedByDataSaver = 0;
            int creditsInheritGeneratedByDataSaver = 0;
            for (UNGP_DataSaverAPI dataSaver : pickedInheritData.dataSavers) {
                if (dataSaver instanceof UNGP_BlueprintsDataSaver) {
                    UNGP_BlueprintsDataSaver blueprintsDataSaver = (UNGP_BlueprintsDataSaver) dataSaver;
                    bpInheritGeneratedByDataSaver = (int) (blueprintsDataSaver.bpAmount * inherit_bpsFactor);
                }
                if (dataSaver instanceof UNGP_CreditsDataSaver) {
                    UNGP_CreditsDataSaver creditsDataSaver = (UNGP_CreditsDataSaver) dataSaver;
                    creditsInheritGeneratedByDataSaver = (int) (creditsDataSaver.credits * inherit_creditsFactor);
                }
            }
            final int bpInherited = bpInheritGeneratedByDataSaver;
            final int creditsInherited = creditsInheritGeneratedByDataSaver;

            final boolean isSpecialistMode = this.isSpecialistMode;
            final Difficulty difficulty = settingEntry_difficulty.getValue();

            TooltipMakerAPI tooltip = textPanel.beginTooltip();
            TooltipMakerAPI section = tooltip.beginImageWithText("graphics/icons/reports/storage24.png", 24f);
            section.addPara(root_i18n.get("inheritOptions"), Misc.getBasePlayerColor(), 0f);
            tooltip.addImageWithText(5f);
            tooltip.setBulletedListMode("       ");
            // background;
            if (pickedBackground != null) {
                tooltip.addSpacer(10f);
                tooltip.setBulletedListMode(null);
                pickedBackground.addDescriptionTooltip(tooltip, pickedInheritData, false);
            }
            tooltip.setBulletedListMode("       ");
            if (difficulty != null) {
                TooltipMakerAPI hardSection = tooltip.beginImageWithText(difficulty.spritePath, 64f);
                hardSection.addPara(root_i18n.get("hardmodeLevel") + ": %s", 0f, difficulty.color, difficulty.name);
                tooltip.addImageWithText(5f);
            }
            tooltip.setBulletedListMode(null);
            textPanel.addTooltip();
            // 确认
            options.addOptionConfirmation(OptionID.INHERIT, new CustomStoryDialogDelegate() {
                @Override
                public String getTitle() {
                    return root_i18n.get("startInherit");
                }

                @Override
                public void createDescription(TooltipMakerAPI info) {
                    float pad = 10f;
                    String credits = Misc.getDGSCredits(creditsInherited);
                    Color hl = Misc.getHighlightColor();
                    Color negative = Misc.getNegativeHighlightColor();
                    pickedBackground.addDescriptionTooltip(info, pickedInheritData, false);
                    //                    info.addImageWithText(0f);
                    info.addSectionHeading("  " + root_i18n.get("inheritConfirmHeading"), Alignment.LMID, 5f);
                    info.addPara(root_i18n.get("inheritConfirmInfo0"), 5f, hl, credits, "" + bpInherited);
                    if (difficulty != null && isSpecialistMode) {
                        info.addSpacer(pad);
                        info.addSectionHeading(root_i18n.format("rulepick_level", difficulty.name), hl, Misc.scaleAlpha(negative, 0.2f), Alignment.MID, pad * 0.5f);
                        float width = info.getPrev().getPosition().getWidth();
                        info.addPara(root_i18n.get("inheritConfirmInfo1"), negative, 5f).setAlignment(Alignment.MID);
                        info.addSpacer(pad);
                        int ruleSize = pickedRules.size();
                        int itemsPerRow = (int) (width / 64f);
                        int page = Math.max(0, ruleSize - 1) / itemsPerRow;

                        for (int i = 0; i <= page; i++) {
                            List<String> ruleSprites = new ArrayList<>();
                            for (int j = i * itemsPerRow; j < (i + 1) * itemsPerRow; j++) {
                                if (j < ruleSize) {
                                    ruleSprites.add(pickedRules.get(j).getSpritePath());
                                }
                            }
                            if (!ruleSprites.isEmpty()) {
                                String[] array = ruleSprites.toArray(new String[0]);
                                info.addImages(width, 64f, 0f, 4f, array);
                            }
                        }
                    }
                }
            });
        }
    }

    @Override
    public void backFromEngagement(EngagementResultAPI battleResult) {

    }

    private void addLeaveButton() {
        options.addOption(root_i18n.get("leave"), OptionID.LEAVE);
    }

    private void addBackButton(OptionID warpOption) {
        options.addOption(root_i18n.get("back"), warpOption);
    }

    @Override
    public Object getContext() {
        return null;
    }

    @Override
    public Map<String, MemoryAPI> getMemoryMap() {
        return null;
    }

    public void resetSettings() {
        settingEntry_difficulty.reset();
        pickedBackground = UNGP_BackgroundManager.getDefaultBackground();
        backgroundCheckBoxGroup = null;
        isSpecialistMode = false;
        pickedRules.clear();
    }

    private static class DifficultyTooltipCreator implements TooltipMakerAPI.TooltipCreator {
        private Difficulty difficulty;

        public DifficultyTooltipCreator(Difficulty difficulty) {
            this.difficulty = difficulty;
        }

        @Override
        public boolean isTooltipExpandable(Object tooltipParam) {
            return false;
        }

        @Override
        public float getTooltipWidth(Object tooltipParam) {
            return 200f;
        }

        @Override
        public void createTooltip(TooltipMakerAPI tooltip, boolean expanded, Object tooltipParam) {
            if (difficulty == null) {
                tooltip.addPara(root_i18n.get("difficulty_desc_null"), 0);
            } else {
                Color hl = Misc.getHighlightColor();
                tooltip.addPara(root_i18n.get("difficulty_desc_base") + "%s / %s", 0f, hl,
                                difficulty.minRules + "",
                                difficulty.maxRules + "");
                tooltip.addPara(root_i18n.get("difficulty_desc_value") + "%s", 0f, hl,
                                (int) (difficulty.extraValueMultiplier * 100f) + "%");
                if (UNGP_ChallengeManager.isDifficultyEnough(difficulty)) {
                    tooltip.addPara(root_i18n.get("difficulty_desc_max"), hl, 5f);
                }
            }
        }
    }

    private class InheritOptionsDelegate extends BaseCustomDialogDelegate {

        @Override
        public void createCustomDialog(CustomPanelAPI panel, CustomDialogCallback callback) {
            float width = panel.getPosition().getWidth();
            float height = panel.getPosition().getHeight();
            //            float pad = 5f;

            float backgroundHeight = height * 0.8f;
            float extraOptionsHeight = height - backgroundHeight;
            float backgroundTitleHeight = 30f;

            UNGP_Background previousBackground = null;
            if (pickedBackground != null) {
                previousBackground = pickedBackground;
            }
            backgroundCheckBoxGroup = new CheckBoxGroup();

            // title: choose your background
            TooltipMakerAPI backgroundTitleTip = panel.createUIElement(width, backgroundTitleHeight, false);
            backgroundTitleTip.setParaOrbitronLarge();
            backgroundTitleTip.addPara(root_i18n.get("inherit_choose_background"), Misc.getBasePlayerColor(), 0);
            panel.addUIElement(backgroundTitleTip).inTL(0f, 0f);

            // background scroll part
            TooltipMakerAPI backgroundTip = panel.createUIElement(width, backgroundHeight - backgroundTitleHeight, true);
            backgroundTip.setParaOrbitronLarge();

            final float backgroundBoxWidth = width - 10f;
            float spacerHeight = 5f;
            List<UNGP_Background> allBackgrounds = UNGP_BackgroundManager.getSortedBackgroundsCopy();
            // iterate backgrounds
            for (final UNGP_Background background : allBackgrounds) {
                ButtonAPI checkbox = backgroundTip.addAreaCheckbox("", null, Misc.getBasePlayerColor(), Misc.getDarkPlayerColor(), Misc.getBrightPlayerColor(), 0, 0, 0f, true);
                backgroundTip.addTooltipToPrevious(new UNGP_Background.BackgroundTooltipCreator(
                                                           background,
                                                           pickedInheritData,
                                                           backgroundBoxWidth - 20f),
                                                   TooltipMakerAPI.TooltipLocation.BELOW);
                background.addShortDescTooltipWithIcon(backgroundTip, spacerHeight);
                PositionAPI imageWithTextPosition = backgroundTip.getPrev().getPosition();
                float imageWithTextHeight = imageWithTextPosition.getHeight();
                float imageWithTextWidth = imageWithTextPosition.getWidth();
                float imageWithTextXOffset = 7f;
                backgroundTip.addSpacer(spacerHeight);
                imageWithTextPosition.setXAlignOffset(imageWithTextXOffset);
                imageWithTextPosition.setSize(imageWithTextWidth - 15f, imageWithTextHeight);
                checkbox.getPosition().setSize(backgroundBoxWidth, imageWithTextHeight + spacerHeight * 2f);
                imageWithTextPosition.setYAlignOffset(imageWithTextHeight + spacerHeight);
                backgroundTip.addSpacer(0f).getPosition().setXAlignOffset(-imageWithTextXOffset);
                backgroundCheckBoxGroup.addCheckBox(checkbox, background);
            }
            backgroundTip.addSpacer(0f);
            panel.addUIElement(backgroundTip).inTL(0f, backgroundTitleHeight);

            TooltipMakerAPI tooltip = panel.createUIElement(width, extraOptionsHeight, false);
            tooltip.setParaOrbitronLarge();
            tooltip.setAreaCheckboxFont(Fonts.ORBITRON_24AA);
            tooltip.addSpacer(10f);

            if (previousBackground != null) {
                backgroundCheckBoxGroup.tryCheckValue(previousBackground);
            } else {
                backgroundCheckBoxGroup.tryCheckValue(UNGP_BackgroundManager.getDefaultBackground());
            }
            settingEntry_difficulty.addEntry(tooltip, width);
            panel.addUIElement(tooltip).inTL(0f, backgroundHeight);
        }


        @Override
        public boolean hasCancelButton() {
            return true;
        }

        @Override
        public void customDialogConfirm() {
            if (backgroundCheckBoxGroup != null)
                pickedBackground = (UNGP_Background) backgroundCheckBoxGroup.getCheckedValue();
            Difficulty difficulty = settingEntry_difficulty.confirmValue();
            isSpecialistMode = difficulty != null;
            optionSelected(null, choseInheritSlotOptionID);
        }

        @Override
        public void customDialogCancel() {
            settingEntry_difficulty.cancelConfirm();
            optionSelected(null, choseInheritSlotOptionID);
        }

        @Override
        public CustomUIPanelPlugin getCustomPanelPlugin() {
            return new CustomUIPanelPlugin() {
                @Override
                public void positionChanged(PositionAPI position) {

                }

                @Override
                public void renderBelow(float alphaMult) {

                }

                @Override
                public void render(float alphaMult) {

                }

                @Override
                public void advance(float amount) {
                    if (backgroundCheckBoxGroup != null)
                        backgroundCheckBoxGroup.updateCheck();
                    settingEntry_difficulty.advance(amount);
                }

                @Override
                public void processInput(List<InputEventAPI> events) {

                }

                @Override
                public void buttonPressed(Object buttonId) {

                }
            };
        }
    }

    private class CustomStoryDialogDelegate extends BaseStoryPointActionDelegate {
        @Override
        public boolean withDescription() {
            return true;
        }

        @Override
        public boolean withSPInfo() {
            return false;
        }

        @Override
        public String getLogText() {
            return null;
        }

        @Override
        public float getBonusXPFraction() {
            return 0;
        }

        @Override
        public TextPanelAPI getTextPanel() {
            if (dialog == null) return null;
            return textPanel;
        }

        @Override
        public String getConfirmSoundId() {
            return "ui_acquired_blueprint";
        }

        @Override
        public int getRequiredStoryPoints() {
            return 0;
        }
    }

    /**
     * Used while saving.
     */
    private class RecordDialogDelegate extends BaseCustomDialogDelegate {
        private ButtonAPI btn_recordCargo;
        private ButtonAPI btn_recordShip;
        private ButtonAPI btn_recordColony;

        private ButtonAPI btn_recordSlotBPs;

        private OptionID selectedOption;

        public RecordDialogDelegate(OptionID selectedOption) {
            this.selectedOption = selectedOption;
        }

        @Override
        public void createCustomDialog(CustomPanelAPI panel, CustomDialogCallback callback) {
            float width = panel.getPosition().getWidth();
            float height = panel.getPosition().getHeight();
            float pad = 5f;

            TooltipMakerAPI info = panel.createUIElement(width, height, true);
            panel.addUIElement(info);
            info.setParaOrbitronLarge();
            info.addPara(root_i18n.get("recordConfirmInfo"), Misc.getNegativeHighlightColor(), 0f);
            info.addSpacer(30f);
            info.setAreaCheckboxFont(Fonts.ORBITRON_24AA);
            info.addPara(root_i18n.get("recordExtraCreditsTitle"), Misc.getHighlightColor(), 0f);
            info.addSpacer(pad);
            float buttonWidth = width / 3f - 10f;
            float buttonHeight = 30f;

            HorizontalButtonGroup extraCreditsGroup = new HorizontalButtonGroup();
            btn_recordCargo = info.addAreaCheckbox(root_i18n.get("recordExtraCredits_cargo"), null, Misc.getBasePlayerColor(),
                                                   Misc.getDarkPlayerColor(), Misc.getBrightPlayerColor(), buttonWidth, buttonHeight, 0f);
            btn_recordShip = info.addAreaCheckbox(root_i18n.get("recordExtraCredits_ship"), null, Misc.getBasePlayerColor(),
                                                  Misc.getDarkPlayerColor(), Misc.getBrightPlayerColor(), buttonWidth, buttonHeight, 0f);
            btn_recordColony = info.addAreaCheckbox(root_i18n.get("recordExtraCredits_colony"), null, Misc.getBasePlayerColor(),
                                                    Misc.getDarkPlayerColor(), Misc.getBrightPlayerColor(), buttonWidth, buttonHeight, 0f);
            extraCreditsGroup.addButton(btn_recordCargo);
            extraCreditsGroup.addButton(btn_recordShip);
            extraCreditsGroup.addButton(btn_recordColony);
            extraCreditsGroup.updateTooltip(info, 10f);

            info.addSpacer(pad);
            info.addPara(root_i18n.get("recordExtraBPsTitle"), Misc.getHighlightColor(), 0f);
            info.addSpacer(pad);
            btn_recordSlotBPs = info.addAreaCheckbox(root_i18n.get("recordExtraBPs_selectedSlot"), null, Misc.getBasePlayerColor(),
                                                     Misc.getDarkPlayerColor(), Misc.getBrightPlayerColor(), buttonWidth, buttonHeight, 0f);
        }

        @Override
        public boolean hasCancelButton() {
            return true;
        }

        @Override
        public String getConfirmText() {
            return null;
        }

        @Override
        public String getCancelText() {
            return null;
        }

        @Override
        public void customDialogConfirm() {
            float extraCredits = 0;
            boolean recordCargo = btn_recordCargo.isChecked();
            boolean recordShip = btn_recordShip.isChecked();
            boolean recordIndustry = btn_recordColony.isChecked();
            boolean recordSelectedSlotBPs = btn_recordSlotBPs.isChecked();
            CargoAPI convertCargo = Global.getFactory().createCargo(true);
            for (MarketAPI market : Global.getSector().getEconomy().getMarketsCopy()) {
                if (Misc.playerHasStorageAccess(market)) {
                    CargoAPI storageCargo = Misc.getStorageCargo(market);
                    if (storageCargo != null) {
                        if (recordCargo) {
                            convertCargo.addAll(storageCargo);
                        }
                        if (recordShip) {
                            FleetDataAPI mothballedShips = storageCargo.getMothballedShips();
                            if (mothballedShips != null)
                                for (FleetMemberAPI member : mothballedShips.getMembersListCopy()) {
                                    extraCredits += member.getBaseValue();
                                }
                        }
                    }
                }
                if (recordIndustry) {
                    if (market.isPlayerOwned()) {
                        for (Industry industry : market.getIndustries()) {
                            extraCredits += industry.getBuildCost();
                        }
                    }
                }
            }
            CampaignFleetAPI playerFleet = Global.getSector().getPlayerFleet();
            CargoAPI playerCargo = playerFleet.getCargo();
            if (recordCargo) {
                convertCargo.addAll(playerCargo);
                for (CargoStackAPI stack : convertCargo.getStacksCopy()) {
                    extraCredits += stack.getBaseValuePerUnit() * stack.getSize();
                }
            }
            if (recordShip) {
                if (playerFleet.getFleetData() != null)
                    for (FleetMemberAPI member : playerFleet.getFleetData().getMembersListCopy()) {
                        extraCredits += member.getBaseValue();
                    }
            }
            textPanel.addPara(root_i18n.get("recordExtraCredits_success") + " %s ", Misc.getHighlightColor(), Misc.getDGSCredits(extraCredits));
            for (UNGP_DataSaverAPI dataSaver : pregenInheritData.dataSavers) {
                if (dataSaver instanceof UNGP_CreditsDataSaver) {
                    ((UNGP_CreditsDataSaver) dataSaver).credits += extraCredits;
                }
                if (recordSelectedSlotBPs && dataSaver instanceof UNGP_BlueprintsDataSaver) {
                    UNGP_InheritData dataFromSlot = UNGP_InheritManager.getDataFromSlot(getSlotIdByOption(selectedOption));
                    if (dataFromSlot != null) {
                        UNGP_BlueprintsDataSaver bpSaverFromSlot = dataFromSlot.getFirstSaverOfClass(UNGP_BlueprintsDataSaver.class);
                        if (bpSaverFromSlot != null) {
                            int extraBPAmount = ((UNGP_BlueprintsDataSaver) dataSaver).add(bpSaverFromSlot);
                            textPanel.addPara(root_i18n.get("recordExtraBPs_success"), Misc.getHighlightColor(), extraBPAmount + "");
                        }
                    }
                }
            }
            record(selectedOption);
        }

        @Override
        public void customDialogCancel() {
            optionSelected(null, OptionID.CHECK_RECORD_SLOTS);
        }

        @Override
        public CustomUIPanelPlugin getCustomPanelPlugin() {
            return null;
        }
    }

    /**
     * Used for inherit options
     *
     * @param <T>
     */
    private abstract static class InheritSettingEntry<T> implements UNGP_DataSaverSettingEntryAPI<T> {
        private SettingEntry<T> valueEntry;
        protected String entryTitle;
        protected Color entryTitleColor;
        protected Object[] optionValues;
        protected String[] optionNames;
        protected Color[] optionBaseColor;
        protected Color[] optionDarkColor;
        protected Color[] optionBrightColor;
        protected CheckBoxGroup checkBoxGroup;
        protected HorizontalButtonGroup optionGroup;

        public InheritSettingEntry(T defaultValue, int optionSize) {
            valueEntry = new SettingEntry<>(defaultValue);
            optionValues = new Object[optionSize];
            optionNames = new String[optionSize];
            optionBaseColor = new Color[optionSize];
            optionDarkColor = new Color[optionSize];
            optionBrightColor = new Color[optionSize];
            initParams(optionSize);
        }

        public abstract void initParams(int optionSize);

        public void addEntry(TooltipMakerAPI tooltip, float width) {
            checkBoxGroup = new CheckBoxGroup();
            optionGroup = new HorizontalButtonGroup();
            tooltip.addPara(entryTitle, entryTitleColor, 0f);
            tooltip.addSpacer(5f);
            int optionSize = optionValues.length;
            float buttonWidth = width / optionSize - 10f;
            {
                for (int i = 0; i < optionSize; i++) {
                    Object value = optionValues[i];
                    ButtonAPI checkBox = tooltip.addAreaCheckbox(optionNames[i], null, optionBaseColor[i],
                                                                 optionDarkColor[i], optionBrightColor[i],
                                                                 buttonWidth, 30f, 0f);
                    addTipToOption(tooltip, value);
                    optionGroup.addButton(checkBox);
                    checkBoxGroup.addCheckBox(checkBox, value);
                }
                optionGroup.updateTooltip(tooltip, 5f);
            }
            checkBoxGroup.tryCheckValue(valueEntry.get());
        }

        /**
         * Should only call {@link TooltipMakerAPI#addTooltipToPrevious(TooltipMakerAPI.TooltipCreator, TooltipMakerAPI.TooltipLocation)}
         *
         * @param tooltip
         * @param option
         */
        protected void addTipToOption(TooltipMakerAPI tooltip, Object option) {

        }

        public void reset() {
            cancelConfirm();
            valueEntry.reset();
        }

        public void advance(float amount) {
            if (checkBoxGroup != null)
                checkBoxGroup.updateCheck();
        }

        public T confirmValue() {
            T value = (T) checkBoxGroup.getCheckedValue();
            valueEntry.set(value);
            return value;
        }

        public void cancelConfirm() {
            checkBoxGroup = null;
            optionGroup = null;
        }

        @Override
        public T getValue() {
            return valueEntry.get();
        }
    }
}
